---
title: "replicationGames"
author: "Steph, Sam, Iggy"
date: "2025-12-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load Packages
library(readr) # read csv file in
library(dplyr) # wrangling
library(tidyr) # Remove NAs in merged data
library(lubridate) # dates | not used?
library(sf) # for reading .shp data
library(tsModel) # for runMean() - e.g. fig 1c
library(ggplot2) # graphing

```

```{r}
# Set seed for randomisation purposes
set.seed(2025)

# Setup - Load in data file
# set working directory as source file location
# Read in upzipped .csv data from "input" folder within

# Read in PM2.5 and evironmental data
df1 <- read_csv("input/Data_2000-2016_county_monthly_combined.csv")

# Read in overall mortality data
df2 <- rbind(
  read_csv("input/CompMort_01_08.csv"),
  read_csv("input/CompMort_09_16.csv")
)

# Merge data
df3 <- merge(
  mutate(filter(df2, !is.na("Year")), GEOID = `County Code`, year = Year),
  df1,
  by = c("GEOID", "year")
)

# Clean data
df3 <- df3 %>%
  mutate(
    CVD.adj = as.numeric(`Age Adjusted Rate`, na.rm = TRUE),
    GEOID = as.factor(GEOID)
  ) %>% # change column classes
  dplyr::select(
    c(
      GEOID,
      year_month,
      year,
      month,
      PM25,
      NO2,
      O3,
      Tmean,
      dewT,
      pop.total,
      pop.Male,
      pop.Female,
      pop.White,
      pop.Black,
      pop.Hispanic,
      CVD.adj
    )
  ) # Select required columns

# Add in dummy data for columns missing from mortality data
missing_columns <- readLines("input/missing_columns.txt")

# Make dummy data with only positive numbers
dummy_data <- matrix(
  data = abs(rnorm(length(missing_columns) * nrow(df3))),
  nrow = nrow(df3),
  ncol = length(missing_columns)
)

colnames(dummy_data) <- missing_columns

df4 <- bind_cols(
  df3,
  dummy_data
)

# Read in .shp US countys geospatial data us sf package
US.county <- st_read("input/US_continental_counties_3103/US_continental_counties_3103.shp")
```

## Iggy Section

code goes here

```{r cars}
summary(cars)
```

## Steph Section

### Figure 1ab

#### Figure 1ab (Their Code)

```{r}
# using packages dplyr, lubridate, & sf
# lubridate not actually used?

# SJH added
# re assign df1 "Data_2000-2016_county_monthly_combined.csv" to data
data <- df1

## average PM2.5 (Figure 1a)
PM25.ave <- data %>%
  group_by(GEOID) %>%
  summarise(PM25_mean = mean(PM25))

## PM2.5 change (Figure 1b)
PM25.2000 <- data %>%
  filter(year == 2000) %>%
  group_by(GEOID) %>%
  summarise(PM25_2000 = mean(PM25))

PM25.2016 <- data %>%
  filter(year == 2016) %>%
  group_by(GEOID) %>%
  summarise(PM25_2016 = mean(PM25))

PM25.change <- PM25.2000 %>%
  left_join(PM25.2016, by = c("GEOID")) %>%
  mutate(PM25_chg = (PM25_2016 - PM25_2000) / PM25_2000 * 100) %>%
  dplyr::select(GEOID, PM25_chg)


## join with shapefile
PM25.ave$GEOID <- as.character(PM25.ave$GEOID)
PM25.change$GEOID <- as.character(PM25.change$GEOID)

US.county.F1 <- US.county %>%
  left_join(PM25.ave, by = "GEOID") %>%
  left_join(PM25.change, by = "GEOID")
```

#### Figre 1ab (SJH code)

-   Note - "ArcGIS Pro was used to make the final maps." (Github \> Analysis Description.pdf \> 2.2 Descriptive Maps)

    -   Attempting to use the sf package to map information instead.

    -   <https://r-spatial.github.io/sf/articles/sf5.html>

    -   <https://r-spatial.github.io/sf/articles/sf5.html#ggplot2>

```{r}
# Using sf package to plot geography/Ca
# Basic plot of the USA
plot(st_geometry(US.county.F1))

# basic ggplot test of PM25_mean plot
ggplot() +
  geom_sf(data = US.county.F1, aes(fill = PM25_mean)) +
  # scale_y_continuous(breaks = 34:36)
  theme_bw()
```

##### Data prep for Fig 1a & 1b

```{r}
# Make new df with categoies/ranks columns (in prep for color mapping on US map)
US.county.F1ab <- US.county.F1 %>%
  mutate(
    PM25_mean_rank = case_when(
      PM25_mean > 12 ~ "12.01-13.74",
      PM25_mean > 9 ~ "9.00-12.00",
      PM25_mean > 6 ~ "6.00-9.00",
      PM25_mean > 3 ~ "3.00-6.00",
      PM25_mean <= 3 ~ "2.15-3.00",
      TRUE ~ "F" # Default case: if none of the above are true
    )
  ) %>%
  mutate(
    PM25_chg_rank = case_when(
      PM25_chg > 20 ~ "20.00-52.99",
      PM25_chg > 0 ~ "0.00-20.00",
      PM25_chg > -20 ~ "-20.00-0.00",
      PM25_chg > -40 ~ "-40.01--20.00",
      PM25_chg <= -40 ~ "-60.43--40.00",
      TRUE ~ "F" # Default case: if none of the above are true
    )
  )

# Colors used in figure 1a
fig_1a_colors <- c("#006837", "#86CB67", "#FFFFBF", "#F98E52", "#A50026")

# Colors used in figure 1b
fig_1b_colors <- c("#313695", "#74ADD1", "#E0F3F8", "#F98E52", "#A50026")
```

##### Figure 1a replication

```{r}
fig_1a <- ggplot() +
  geom_sf(data = US.county.F1ab, aes(fill = PM25_mean_rank)) +
  scale_fill_manual(
    name = "Average PM2.5 \nconcentration (\u00B5g/m\u00b3)",
    breaks = c(
      "2.15-3.00", "3.00-6.00", "6.00-9.00",
      "9.00-12.00", "12.01-13.74"
    ),
    values = c(
      "#006837", "#86CB67", "#FFFFBF",
      "#F98E52", "#A50026"
    )
  ) +
  labs(title = "Figure 1a") +
  theme_bw()

fig_1a
```

##### Figure 1b Replication

```{r}
fig_1b <- ggplot() +
  geom_sf(data = US.county.F1ab, aes(fill = PM25_chg_rank)) +
  scale_fill_manual(
    name = "Change in PM2.5 \nconcentration (%)",
    breaks = c(
      "-60.43--40.00", "-40.01--20.00", "-20.00-0.00",
      "0.00-20.00", "20.00-52.99"
    ),
    values = c(
      "#313695", "#74ADD1", "#E0F3F8",
      "#F98E52", "#A50026"
    )
  ) +
  labs(title = "Figure 1b") +
  theme_bw() 

fig_1b
```

### Figure 1c

#### Figure 1c (Their Code)

```{r}
library(dplyr)
library(ggplot2)
library(cowplot)
library(MetBrewer)

## filter for cardiovascular mortality data
mortality.CVD <- mortality %>%
  filter(ICD.category == "I" & ICD.number >= 0 & ICD.number <= 99.99) %>%
  dplyr::select(year_month, res_FIPS, race, hispanic) %>%
  rename(GEOID = res_FIPS) %>%
  mutate(
    race_cat = case_when(
      race == 1 & hispanic == 0 ~ "non-Hispanic White",
      race == 2 & hispanic == 0 ~ "non-Hispanic Black",
      hispanic == 1 ~ "Hispanic"
    ),
    race_cat = factor(race_cat, levels = c("non-Hispanic White", "non-Hispanic Black", "Hispanic"))
  ) %>%
  dplyr::select(GEOID, year_month, race_cat) %>%
  filter(is.na(race_cat) == F)

rm(mortality)


## select PM2.5 data
data.AP <- data %>%
  dplyr::select(GEOID, year_month, year, PM25)

## 12-month moving average of PM2.5 concentration
data.list <- split(data.AP, as.factor(data$GEOID))
for (j in 1:length(data.list)) {
  data.list[[j]][, paste0("PM25_lag0", 11)] <- tsModel::runMean(data.list[[j]]$PM25, c(0:11))
}

data.AP.01to16 <- bind_rows(data.list) %>%
  filter(year >= 2001) %>%
  dplyr::select(-PM25, -year)


## individual-level long-term PM2.5 exposure
AP.individual <- mortality.CVD %>%
  left_join(data.AP, by = c("GEOID", "year_month")) %>%
  left_join(data.AP.01to16, by = c("GEOID", "year_month"))

## make the violin plot
theme_set(theme_cowplot())

plot.individual.12M <- ggplot(AP.individual, aes(x = race_cat, y = PM25_lag011, fill = race_cat)) +
  geom_violin() +
  scale_fill_met_d("Kandinsky", direction = 1) +
  geom_boxplot(width = 0.1, color = "grey", alpha = 0.2) +
  xlab("") +
  ylab("12-month moving average of PM2.5") +
  theme(legend.position = "none")
```

##### Data Checking for Fig1c

```{r}

```

#### Figure 1c (SJH code)

NOTE - COMEBACK TO - TO FIGURE OUT MORTALITY BY RACE DATA FIRST!!!

```{r}
# mortality.CVD_df4 <- df4 %>%
  


# Taken directly from their code 
## select PM2.5 data
data.AP <- data %>%
  dplyr::select(GEOID, year_month, year, PM25)

## 12-month moving average of PM2.5 concentration
data.list <- split(data.AP, as.factor(data$GEOID))
for (j in 1:length(data.list)) {
  data.list[[j]][, paste0("PM25_lag0", 11)] <- tsModel::runMean(data.list[[j]]$PM25, c(0:11))
}

data.AP.01to16 <- bind_rows(data.list) %>%
  filter(year >= 2001) %>%
  dplyr::select(-PM25, -year)   




```

### Supp Fig 1

### Supp Fig 2

-   Works and generally appears similar but not as granular as the one in the paper...?

    -   Also why does it go up in 2017???

        -   <https://lubridate.tidyverse.org/reference/as_date.html>

```{r}
# Cut off at <5000
sfig_2 <- df4 %>%
  filter(pop.total < 5000) %>%
  mutate(year_month = lubridate::ym(year_month)) %>% 
  group_by(year_month) %>%
  mutate(monthly_mean_CVD.adj = mean(CVD.adj, na.rm = TRUE)) %>%
  ggplot(aes(x = year_month, y = monthly_mean_CVD.adj)) +
  geom_line() +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "6 month",
               labels = ) +
  labs(title = "Supplementary Figure 2 (pop <5000)") +
  #geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) 
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5), # vertical x labels
        )
  
sfig_2
```

Decrease appears more stable when the population cut off is \<50000 rather than \<5000

```{r}
# Cut off at <50000
sfig_2.v2 <- df4 %>%
  filter(pop.total < 50000) %>%
  mutate(year_month = lubridate::ym(year_month)) %>% 
  group_by(year_month) %>%
  mutate(monthly_mean_CVD.adj = mean(CVD.adj, na.rm = TRUE)) %>%
  ggplot(aes(x = year_month, y = monthly_mean_CVD.adj)) +
  geom_line() +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "6 month",
               labels = ) +
  labs(title = "Supplementary Figure 2 v2 (pop <50000)") +
  #geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) 
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5), # vertical x labels
        )
  
sfig_2.v2
```

## Sam Section

Code goes here
